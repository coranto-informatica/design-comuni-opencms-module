name: Build ZIP of it.coranto.comuni

on:
  workflow_dispatch:

  push:
    branches:
      - main
    paths:
      - "it.coranto.comuni/**"
      - ".github/workflows/build-it-coranto-comuni-zip.yml"

permissions:
  contents: write 

jobs:
  build-zip:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read softwareVersion from publiccode.yml
        id: version
        run: |
          VERSION=$(grep 'softwareVersion:' publiccode.yml | sed 's/.*"\(.*\)".*/\1/')
          echo "Found softwareVersion: $VERSION"
          echo "SOFTWARE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare OpenCms module structure
        run: |
          mkdir -p build/system/modules/it.coranto.comuni
          cp -R it.coranto.comuni/* build/system/modules/it.coranto.comuni/

      - name: Create ZIP of module (OpenCms structure)
        run: |
          cd build
          zip -r ../it.coranto.comuni.zip system

      - name: Create or update release with ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Design Comuni OpenCms v${{ env.SOFTWARE_VERSION }}"
          files: it.coranto.comuni.zip
          body: |
            **Version:** ${{ env.SOFTWARE_VERSION }}

            **Design Comuni OpenCms** is an OpenCms module implementing the official
            design system for Italian municipalities' websites, following the
            Designers Italia guidelines.

            It provides templates, graphic assets, and ready-to-use configurations
            without editorial content, enabling public bodies to quickly build
            accessible and compliant municipal websites.

            **Key Features**
            - Compatible with OpenCms 19
            - WCAG 2.1 AA accessibility compliant
            - BSD-3-Clause licensed
            - No proprietary dependencies

            **Requirements**
            - OpenCms ≥ 19.0.0
            - Java ≥ 11
            - Apache Tomcat ≥ 9.0

            **Project Links**
            - Repository: https://github.com/coranto-informatica/design-comuni-opencms-module
            - Issues: https://github.com/coranto-informatica/design-comuni-opencms-module/issues
            - Roadmap: https://github.com/coranto-informatica/design-comuni-opencms-module/milestones
